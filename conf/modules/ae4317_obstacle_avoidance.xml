<!DOCTYPE module SYSTEM "module.dtd">

<module name="ae4317_obstacle_avoidance" dir="ae4317_obstacle_avoidance">
  <doc>
    <description>
        This module performs obstacle avoidance based on optical flow extracted from the front camera of a Parrot ARdrone 2.
        Obstacles are detected from this optical flow, and large pieces of the image without features ('featureless zones').
        Based on these obstacle detections, the drone is navigated left or right, and in the event of a near collision, it 
        stops and makes an (approximately) 90deg turn left or right.

        NOTE: in order to be functional, the flight plan 'rotorcraft_obstacle_avoidance' MUST be used.
        
        AE4317 'Autonomous Flight of MAVs' - Obstacle Avoidance Competition Group 3
        Delft University of Technology
        Faculty of Aerospace Engineering
        Department of Control and Simulation
    </description>

    <define name="OPTICFLOW_AGL_ID" value="ABI_SENDER_ID" description="ABI sender id for AGL message (sonar measurement) (default: ABI_BROADCAST)"/>
  </doc>

  <header>
    <file name="opticflow_module.h"/>
  </header>

  <init fun="opticflow_module_init()"/>
  <periodic fun="opticflow_module_run()" start="opticflow_module_start()" stop="opticflow_module_stop()" autorun="TRUE"/>

  <makefile target="ap|sim|jsbsim|nps">
    <!-- Include the needed Computer Vision files -->
    <define name="modules/ae4317_obstacle_avoidance" type="include"/>
    <file name="image.c" dir="modules/ae4317_obstacle_avoidance/lib/vision"/>
    <file name="jpeg.c" dir="modules/ae4317_obstacle_avoidance/lib/encoding"/>
    <file name="v4l2.c" dir="modules/ae4317_obstacle_avoidance/lib/v4l"/>

    <!-- The optical flow module (main thread)-->
    <file name="opticflow_module.c"/>

    <!-- Optical flow determination -->
    <file name="opticflow_calculator.c" dir="modules/ae4317_obstacle_avoidance/opticflow"/>
    
    <!-- Navigation commands -->
    <file name="obstacle_avoidance_navigation.c"/>

    <!-- Main vision calculations -->
    <file name="fast_rosten.c" dir="modules/ae4317_obstacle_avoidance/lib/vision"/>
    <file name="lucas_kanade.c" dir="modules/ae4317_obstacle_avoidance/lib/vision"/>
    
    <!-- Tobias: Add flags to include all required libraries -->
    <flag name="LDFLAGS" value="pthread"/>
    <flag name="LDFLAGS" value="lrt"/>
    <flag name="LDFLAGS" value="static"/>
  </makefile>

</module>

